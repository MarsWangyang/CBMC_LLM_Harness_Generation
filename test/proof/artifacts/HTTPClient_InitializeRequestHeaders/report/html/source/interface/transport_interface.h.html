
<html>
<head>
<title>source/interface/transport_interface.h</title>
<link rel="stylesheet" type="text/css" href="../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * coreHTTP v3.1.1</div><div id="3" class="line none">    3  * Copyright (C) 2022 Amazon.com, Inc. or its affiliates.  All Rights Reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * SPDX-License-Identifier: MIT</div><div id="6" class="line none">    6  *</div><div id="7" class="line none">    7  * Permission is hereby granted, free of charge, to any person obtaining a copy of</div><div id="8" class="line none">    8  * this software and associated documentation files (the "Software"), to deal in</div><div id="9" class="line none">    9  * the Software without restriction, including without limitation the rights to</div><div id="10" class="line none">   10  * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</div><div id="11" class="line none">   11  * the Software, and to permit persons to whom the Software is furnished to do so,</div><div id="12" class="line none">   12  * subject to the following conditions:</div><div id="13" class="line none">   13  *</div><div id="14" class="line none">   14  * The above copyright notice and this permission notice shall be included in all</div><div id="15" class="line none">   15  * copies or substantial portions of the Software.</div><div id="16" class="line none">   16  *</div><div id="17" class="line none">   17  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div><div id="18" class="line none">   18  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</div><div id="19" class="line none">   19  * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</div><div id="20" class="line none">   20  * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</div><div id="21" class="line none">   21  * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</div><div id="22" class="line none">   22  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</div><div id="23" class="line none">   23  */</div><div id="24" class="line none">   24 </div><div id="25" class="line none">   25 /**</div><div id="26" class="line none">   26  * @file transport_interface.h</div><div id="27" class="line none">   27  * @brief Transport interface definitions to send and receive data over the</div><div id="28" class="line none">   28  * network.</div><div id="29" class="line none">   29  */</div><div id="30" class="line none">   30 #ifndef <a href="transport_interface.h.html#31">TRANSPORT_INTERFACE_H_</a></div><div id="31" class="line none">   31 #define <a href="transport_interface.h.html#31">TRANSPORT_INTERFACE_H_</a></div><div id="32" class="line none">   32 </div><div id="33" class="line none">   33 #include &lt;stdint.h&gt;</div><div id="34" class="line none">   34 #include &lt;stddef.h&gt;</div><div id="35" class="line none">   35 </div><div id="36" class="line none">   36 /* *INDENT-OFF* */</div><div id="37" class="line none">   37 #ifdef __cplusplus</div><div id="38" class="line none">   38     extern "C" {</div><div id="39" class="line none">   39 #endif</div><div id="40" class="line none">   40 /* *INDENT-ON* */</div><div id="41" class="line none">   41 </div><div id="42" class="line none">   42 /**</div><div id="43" class="line none">   43  * @transportpage</div><div id="44" class="line none">   44  * @brief The transport interface definition.</div><div id="45" class="line none">   45  *</div><div id="46" class="line none">   46  * @transportsectionoverview</div><div id="47" class="line none">   47  *</div><div id="48" class="line none">   48  * The transport interface is a set of APIs that must be implemented using an</div><div id="49" class="line none">   49  * external transport layer protocol. The transport interface is defined in</div><div id="50" class="line none">   50  * @ref transport_interface.h. This interface allows protocols like MQTT and</div><div id="51" class="line none">   51  * HTTP to send and receive data over the transport layer. This</div><div id="52" class="line none">   52  * interface does not handle connection and disconnection to the server of</div><div id="53" class="line none">   53  * interest. The connection, disconnection, and other transport settings, like</div><div id="54" class="line none">   54  * timeout and TLS setup, must be handled in the user application.</div><div id="55" class="line none">   55  * &lt;br&gt;</div><div id="56" class="line none">   56  *</div><div id="57" class="line none">   57  * The functions that must be implemented are:&lt;br&gt;</div><div id="58" class="line none">   58  * - [Transport Receive](@ref TransportRecv_t)</div><div id="59" class="line none">   59  * - [Transport Send](@ref TransportSend_t)</div><div id="60" class="line none">   60  *</div><div id="61" class="line none">   61  * Each of the functions above take in an opaque context @ref NetworkContext_t.</div><div id="62" class="line none">   62  * The functions above and the context are also grouped together in the</div><div id="63" class="line none">   63  * @ref TransportInterface_t structure:&lt;br&gt;&lt;br&gt;</div><div id="64" class="line none">   64  * @snippet this define_transportinterface</div><div id="65" class="line none">   65  * &lt;br&gt;</div><div id="66" class="line none">   66  *</div><div id="67" class="line none">   67  * @transportsectionimplementation</div><div id="68" class="line none">   68  *</div><div id="69" class="line none">   69  * The following steps give guidance on implementing the transport interface:</div><div id="70" class="line none">   70  *</div><div id="71" class="line none">   71  * -# Implementing @ref NetworkContext_t&lt;br&gt;&lt;br&gt;</div><div id="72" class="line none">   72  * @snippet this define_networkcontext</div><div id="73" class="line none">   73  * &lt;br&gt;</div><div id="74" class="line none">   74  * @ref NetworkContext_t is the incomplete type &lt;b&gt;struct NetworkContext&lt;/b&gt;.</div><div id="75" class="line none">   75  * The implemented struct NetworkContext must contain all of the information</div><div id="76" class="line none">   76  * that is needed to receive and send data with the @ref TransportRecv_t</div><div id="77" class="line none">   77  * and the @ref TransportSend_t implementations.&lt;br&gt;</div><div id="78" class="line none">   78  * In the case of TLS over TCP, struct NetworkContext is typically implemented</div><div id="79" class="line none">   79  * with the TCP socket context and a TLS context.&lt;br&gt;&lt;br&gt;</div><div id="80" class="line none">   80  * &lt;b&gt;Example code:&lt;/b&gt;</div><div id="81" class="line none">   81  * @code{c}</div><div id="82" class="line none">   82  * struct NetworkContext</div><div id="83" class="line none">   83  * {</div><div id="84" class="line none">   84  *     struct MyTCPSocketContext tcpSocketContext;</div><div id="85" class="line none">   85  *     struct MyTLSContext tlsContext;</div><div id="86" class="line none">   86  * };</div><div id="87" class="line none">   87  * @endcode</div><div id="88" class="line none">   88  * &lt;br&gt;</div><div id="89" class="line none">   89  * -# Implementing @ref TransportRecv_t&lt;br&gt;&lt;br&gt;</div><div id="90" class="line none">   90  * @snippet this define_transportrecv</div><div id="91" class="line none">   91  * &lt;br&gt;</div><div id="92" class="line none">   92  * This function is expected to populate a buffer, with bytes received from the</div><div id="93" class="line none">   93  * transport, and return the number of bytes placed in the buffer.</div><div id="94" class="line none">   94  * In the case of TLS over TCP, @ref TransportRecv_t is typically implemented by</div><div id="95" class="line none">   95  * calling the TLS layer function to receive data. In case of plaintext TCP</div><div id="96" class="line none">   96  * without TLS, it is typically implemented by calling the TCP layer receive</div><div id="97" class="line none">   97  * function. @ref TransportRecv_t may be invoked multiple times by the protocol</div><div id="98" class="line none">   98  * library, if fewer bytes than were requested to receive are returned.</div><div id="99" class="line none">   99  * &lt;br&gt;&lt;br&gt;</div><div id="100" class="line none">  100  * &lt;b&gt;Example code:&lt;/b&gt;</div><div id="101" class="line none">  101  * @code{c}</div><div id="102" class="line none">  102  * int32_t myNetworkRecvImplementation( NetworkContext_t * pNetworkContext,</div><div id="103" class="line none">  103  *                                      void * pBuffer,</div><div id="104" class="line none">  104  *                                      size_t bytesToRecv )</div><div id="105" class="line none">  105  * {</div><div id="106" class="line none">  106  *     int32_t bytesReceived = 0;</div><div id="107" class="line none">  107  *     bool callTlsRecvFunc = true;</div><div id="108" class="line none">  108  *</div><div id="109" class="line none">  109  *     // For a single byte read request, check if data is available on the network.</div><div id="110" class="line none">  110  *     if( bytesToRecv == 1 )</div><div id="111" class="line none">  111  *     {</div><div id="112" class="line none">  112  *        // If no data is available on the network, do not call TLSRecv</div><div id="113" class="line none">  113  *        // to avoid blocking for socket timeout.</div><div id="114" class="line none">  114  *        if( TLSRecvCount( pNetworkContext-&gt;tlsContext ) == 0 )</div><div id="115" class="line none">  115  *        {</div><div id="116" class="line none">  116  *            callTlsRecvFunc = false;</div><div id="117" class="line none">  117  *        }</div><div id="118" class="line none">  118  *     }</div><div id="119" class="line none">  119  *</div><div id="120" class="line none">  120  *     if( callTlsRecvFunc == true )</div><div id="121" class="line none">  121  *     {</div><div id="122" class="line none">  122  *        bytesReceived = TLSRecv( pNetworkContext-&gt;tlsContext,</div><div id="123" class="line none">  123  *                                 pBuffer,</div><div id="124" class="line none">  124  *                                 bytesToRecv,</div><div id="125" class="line none">  125  *                                 MY_SOCKET_TIMEOUT );</div><div id="126" class="line none">  126  *        if( bytesReceived &lt; 0 )</div><div id="127" class="line none">  127  *        {</div><div id="128" class="line none">  128  *           // If the error code represents a timeout, then the return</div><div id="129" class="line none">  129  *           // code should be translated to zero so that the caller</div><div id="130" class="line none">  130  *           // can retry the read operation.</div><div id="131" class="line none">  131  *           if( bytesReceived == MY_SOCKET_ERROR_TIMEOUT )</div><div id="132" class="line none">  132  *           {</div><div id="133" class="line none">  133  *              bytesReceived = 0;</div><div id="134" class="line none">  134  *           }</div><div id="135" class="line none">  135  *        }</div><div id="136" class="line none">  136  *        // Handle other cases.</div><div id="137" class="line none">  137  *     }</div><div id="138" class="line none">  138  *     return bytesReceived;</div><div id="139" class="line none">  139  * }</div><div id="140" class="line none">  140  * @endcode</div><div id="141" class="line none">  141  * &lt;br&gt;</div><div id="142" class="line none">  142  * -# Implementing @ref TransportSend_t&lt;br&gt;&lt;br&gt;</div><div id="143" class="line none">  143  * @snippet this define_transportsend</div><div id="144" class="line none">  144  * &lt;br&gt;</div><div id="145" class="line none">  145  * This function is expected to send the bytes, in the given buffer over the</div><div id="146" class="line none">  146  * transport, and return the number of bytes sent.</div><div id="147" class="line none">  147  * In the case of TLS over TCP, @ref TransportSend_t is typically implemented by</div><div id="148" class="line none">  148  * calling the TLS layer function to send data. In case of plaintext TCP</div><div id="149" class="line none">  149  * without TLS, it is typically implemented by calling the TCP layer send</div><div id="150" class="line none">  150  * function. @ref TransportSend_t may be invoked multiple times by the protocol</div><div id="151" class="line none">  151  * library, if fewer bytes than were requested to send are returned.</div><div id="152" class="line none">  152  * &lt;br&gt;&lt;br&gt;</div><div id="153" class="line none">  153  * &lt;b&gt;Example code:&lt;/b&gt;</div><div id="154" class="line none">  154  * @code{c}</div><div id="155" class="line none">  155  * int32_t myNetworkSendImplementation( NetworkContext_t * pNetworkContext,</div><div id="156" class="line none">  156  *                                      const void * pBuffer,</div><div id="157" class="line none">  157  *                                      size_t bytesToSend )</div><div id="158" class="line none">  158  * {</div><div id="159" class="line none">  159  *     int32_t bytesSent = 0;</div><div id="160" class="line none">  160  *     bytesSent = TLSSend( pNetworkContext-&gt;tlsContext,</div><div id="161" class="line none">  161  *                          pBuffer,</div><div id="162" class="line none">  162  *                          bytesToSend,</div><div id="163" class="line none">  163  *                          MY_SOCKET_TIMEOUT );</div><div id="164" class="line none">  164  *</div><div id="165" class="line none">  165  *      // If underlying TCP buffer is full, set the return value to zero</div><div id="166" class="line none">  166  *      // so that caller can retry the send operation.</div><div id="167" class="line none">  167  *     if( bytesSent == MY_SOCKET_ERROR_BUFFER_FULL )</div><div id="168" class="line none">  168  *     {</div><div id="169" class="line none">  169  *          bytesSent = 0;</div><div id="170" class="line none">  170  *     }</div><div id="171" class="line none">  171  *     else if( bytesSent &lt; 0 )</div><div id="172" class="line none">  172  *     {</div><div id="173" class="line none">  173  *         // Handle socket error.</div><div id="174" class="line none">  174  *     }</div><div id="175" class="line none">  175  *     // Handle other cases.</div><div id="176" class="line none">  176  *</div><div id="177" class="line none">  177  *     return bytesSent;</div><div id="178" class="line none">  178  * }</div><div id="179" class="line none">  179  * @endcode</div><div id="180" class="line none">  180  */</div><div id="181" class="line none">  181 </div><div id="182" class="line none">  182 /**</div><div id="183" class="line none">  183  * @transportstruct</div><div id="184" class="line none">  184  * @typedef NetworkContext_t</div><div id="185" class="line none">  185  * @brief The NetworkContext is an incomplete type. An implementation of this</div><div id="186" class="line none">  186  * interface must define struct NetworkContext for the system requirements.</div><div id="187" class="line none">  187  * This context is passed into the network interface functions.</div><div id="188" class="line none">  188  */</div><div id="189" class="line none">  189 /* @[define_networkcontext] */</div><div id="190" class="line none">  190 struct <a href="transport_interface.h.html#190">NetworkContext</a>;</div><div id="191" class="line none">  191 typedef struct <a href="transport_interface.h.html#190">NetworkContext</a> <a href="transport_interface.h.html#191">NetworkContext_t</a>;</div><div id="192" class="line none">  192 /* @[define_networkcontext] */</div><div id="193" class="line none">  193 </div><div id="194" class="line none">  194 /**</div><div id="195" class="line none">  195  * @transportcallback</div><div id="196" class="line none">  196  * @brief Transport interface for receiving data on the network.</div><div id="197" class="line none">  197  *</div><div id="198" class="line none">  198  * @note It is HIGHLY RECOMMENDED that the transport receive</div><div id="199" class="line none">  199  * implementation does NOT block.</div><div id="200" class="line none">  200  * coreMQTT will continue to call the transport interface if it receives</div><div id="201" class="line none">  201  * a partial packet until it accumulates enough data to get the complete</div><div id="202" class="line none">  202  * MQTT packet.</div><div id="203" class="line none">  203  *</div><div id="204" class="line none">  204  * @param[in] pNetworkContext Implementation-defined network context.</div><div id="205" class="line none">  205  * @param[in] pBuffer Buffer to receive the data into.</div><div id="206" class="line none">  206  * @param[in] bytesToRecv Number of bytes requested from the network.</div><div id="207" class="line none">  207  *</div><div id="208" class="line none">  208  * @return The number of bytes received or a negative value to indicate</div><div id="209" class="line none">  209  * error.</div><div id="210" class="line none">  210  *</div><div id="211" class="line none">  211  * @note If no data is available on the network to read and no error</div><div id="212" class="line none">  212  * has occurred, zero MUST be the return value. A zero return value</div><div id="213" class="line none">  213  * SHOULD represent that the read operation can be retried by calling</div><div id="214" class="line none">  214  * the API function. Zero MUST NOT be returned if a network disconnection</div><div id="215" class="line none">  215  * has occurred.</div><div id="216" class="line none">  216  */</div><div id="217" class="line none">  217 /* @[define_transportrecv] */</div><div id="218" class="line none">  218 typedef int32_t ( * <a href="transport_interface.h.html#218">TransportRecv_t</a> )( <a href="transport_interface.h.html#191">NetworkContext_t</a> * <a href="transport_interface.h.html#303">pNetworkContext</a>,</div><div id="219" class="line none">  219                                        void * <a href="../include/core_http_client.h.html#380">pBuffer</a>,</div><div id="220" class="line none">  220                                        size_t bytesToRecv );</div><div id="221" class="line none">  221 /* @[define_transportrecv] */</div><div id="222" class="line none">  222 </div><div id="223" class="line none">  223 /**</div><div id="224" class="line none">  224  * @transportcallback</div><div id="225" class="line none">  225  * @brief Transport interface for sending data over the network.</div><div id="226" class="line none">  226  *</div><div id="227" class="line none">  227  * @param[in] pNetworkContext Implementation-defined network context.</div><div id="228" class="line none">  228  * @param[in] pBuffer Buffer containing the bytes to send over the network stack.</div><div id="229" class="line none">  229  * @param[in] bytesToSend Number of bytes to send over the network.</div><div id="230" class="line none">  230  *</div><div id="231" class="line none">  231  * @return The number of bytes sent or a negative value to indicate error.</div><div id="232" class="line none">  232  *</div><div id="233" class="line none">  233  * @note If no data is transmitted over the network due to a full TX buffer and</div><div id="234" class="line none">  234  * no network error has occurred, this MUST return zero as the return value.</div><div id="235" class="line none">  235  * A zero return value SHOULD represent that the send operation can be retried</div><div id="236" class="line none">  236  * by calling the API function. Zero MUST NOT be returned if a network disconnection</div><div id="237" class="line none">  237  * has occurred.</div><div id="238" class="line none">  238  */</div><div id="239" class="line none">  239 /* @[define_transportsend] */</div><div id="240" class="line none">  240 typedef int32_t ( * <a href="transport_interface.h.html#240">TransportSend_t</a> )( <a href="transport_interface.h.html#191">NetworkContext_t</a> * <a href="transport_interface.h.html#303">pNetworkContext</a>,</div><div id="241" class="line none">  241                                        const void * <a href="../include/core_http_client.h.html#380">pBuffer</a>,</div><div id="242" class="line none">  242                                        size_t bytesToSend );</div><div id="243" class="line none">  243 /* @[define_transportsend] */</div><div id="244" class="line none">  244 </div><div id="245" class="line none">  245 /**</div><div id="246" class="line none">  246  * @brief Transport vector structure for sending multiple messages.</div><div id="247" class="line none">  247  */</div><div id="248" class="line none">  248 typedef struct <a href="transport_interface.h.html#248">TransportOutVector</a></div><div id="249" class="line none">  249 {</div><div id="250" class="line none">  250     /**</div><div id="251" class="line none">  251      * @brief Base address of data.</div><div id="252" class="line none">  252      */</div><div id="253" class="line none">  253     const void * <a href="transport_interface.h.html#253">iov_base</a>;</div><div id="254" class="line none">  254 </div><div id="255" class="line none">  255     /**</div><div id="256" class="line none">  256      * @brief Length of data in buffer.</div><div id="257" class="line none">  257      */</div><div id="258" class="line none">  258     size_t <a href="transport_interface.h.html#258">iov_len</a>;</div><div id="259" class="line none">  259 } <a href="transport_interface.h.html#259">TransportOutVector_t</a>;</div><div id="260" class="line none">  260 </div><div id="261" class="line none">  261 /**</div><div id="262" class="line none">  262  * @transportcallback</div><div id="263" class="line none">  263  * @brief Transport interface function for "vectored" / scatter-gather based</div><div id="264" class="line none">  264  * writes. This function is expected to iterate over the list of vectors pIoVec</div><div id="265" class="line none">  265  * having ioVecCount entries containing portions of one MQTT message at a maximum.</div><div id="266" class="line none">  266  * If the proper functionality is available, then the data in the list should be</div><div id="267" class="line none">  267  * copied to the underlying TCP buffer before flushing the buffer. Implementing it</div><div id="268" class="line none">  268  * in this fashion  will lead to sending of fewer TCP packets for all the values</div><div id="269" class="line none">  269  * in the list.</div><div id="270" class="line none">  270  *</div><div id="271" class="line none">  271  * @note If the proper write functionality is not present for a given device/IP-stack,</div><div id="272" class="line none">  272  * then there is no strict requirement to implement write. Only the send and recv</div><div id="273" class="line none">  273  * interfaces must be defined for the application to work properly.</div><div id="274" class="line none">  274  *</div><div id="275" class="line none">  275  * @param[in] pNetworkContext Implementation-defined network context.</div><div id="276" class="line none">  276  * @param[in] pIoVec An array of TransportIoVector_t structs.</div><div id="277" class="line none">  277  * @param[in] ioVecCount Number of TransportIoVector_t in pIoVec.</div><div id="278" class="line none">  278  *</div><div id="279" class="line none">  279  * @return The number of bytes written or a negative value to indicate error.</div><div id="280" class="line none">  280  *</div><div id="281" class="line none">  281  * @note If no data is written to the buffer due to the buffer being full this MUST</div><div id="282" class="line none">  282  * return zero as the return value.</div><div id="283" class="line none">  283  * A zero return value SHOULD represent that the write operation can be retried</div><div id="284" class="line none">  284  * by calling the API function. Zero MUST NOT be returned if a network disconnection</div><div id="285" class="line none">  285  * has occurred.</div><div id="286" class="line none">  286  */</div><div id="287" class="line none">  287 /* @[define_transportwritev] */</div><div id="288" class="line none">  288 typedef int32_t ( * <a href="transport_interface.h.html#288">TransportWritev_t</a> )( <a href="transport_interface.h.html#191">NetworkContext_t</a> * <a href="transport_interface.h.html#303">pNetworkContext</a>,</div><div id="289" class="line none">  289                                          <a href="transport_interface.h.html#259">TransportOutVector_t</a> * pIoVec,</div><div id="290" class="line none">  290                                          size_t ioVecCount );</div><div id="291" class="line none">  291 /* @[define_transportwritev] */</div><div id="292" class="line none">  292 </div><div id="293" class="line none">  293 /**</div><div id="294" class="line none">  294  * @transportstruct</div><div id="295" class="line none">  295  * @brief The transport layer interface.</div><div id="296" class="line none">  296  */</div><div id="297" class="line none">  297 /* @[define_transportinterface] */</div><div id="298" class="line none">  298 typedef struct <a href="transport_interface.h.html#298">TransportInterface</a></div><div id="299" class="line none">  299 {</div><div id="300" class="line none">  300     <a href="transport_interface.h.html#218">TransportRecv_t</a> <a href="transport_interface.h.html#300">recv</a>;               /**&lt; Transport receive function pointer. */</div><div id="301" class="line none">  301     <a href="transport_interface.h.html#240">TransportSend_t</a> <a href="transport_interface.h.html#301">send</a>;               /**&lt; Transport send function pointer. */</div><div id="302" class="line none">  302     <a href="transport_interface.h.html#288">TransportWritev_t</a> <a href="transport_interface.h.html#302">writev</a>;           /**&lt; Transport writev function pointer. */</div><div id="303" class="line none">  303     <a href="transport_interface.h.html#191">NetworkContext_t</a> * <a href="transport_interface.h.html#303">pNetworkContext</a>; /**&lt; Implementation-defined network context. */</div><div id="304" class="line none">  304 } <a href="transport_interface.h.html#304">TransportInterface_t</a>;</div><div id="305" class="line none">  305 /* @[define_transportinterface] */</div><div id="306" class="line none">  306 </div><div id="307" class="line none">  307 /* *INDENT-OFF* */</div><div id="308" class="line none">  308 #ifdef __cplusplus</div><div id="309" class="line none">  309     }</div><div id="310" class="line none">  310 #endif</div><div id="311" class="line none">  311 /* *INDENT-ON* */</div><div id="312" class="line none">  312 </div><div id="313" class="line none">  313 #endif /* ifndef TRANSPORT_INTERFACE_H_ */</div>
</div>
</body>
</html>
